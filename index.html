<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EmailJS Password Reset - Updated Implementation</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Keep all your existing CSS styles exactly the same */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .auth-container {
      display: flex;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      max-width: 900px;
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    .auth-section {
      flex: 1;
      padding: 60px 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 600px;
    }

    .welcome-section {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .welcome-content {
      position: relative;
      z-index: 1;
      text-align: center;
    }

    .logo {
      font-size: 48px;
      margin-bottom: 20px;
      color: #fbbf24;
    }

    .welcome-title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .welcome-subtitle {
      font-size: 18px;
      opacity: 0.9;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .features-list {
      text-align: left;
      margin: 30px 0;
    }

    .feature-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .feature-item i {
      margin-right: 12px;
      color: #fbbf24;
      width: 20px;
    }

    .auth-form {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }

    .form-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .form-header h2 {
      color: #1e3a8a;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .form-header p {
      color: #666;
      font-size: 16px;
    }

    .form-tabs {
      display: flex;
      margin-bottom: 30px;
      background: #f1f5f9;
      border-radius: 10px;
      padding: 4px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #64748b;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: white;
      color: #1e3a8a;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-content {
      position: relative;
      overflow: hidden;
    }

    .form-panel {
      display: none;
    }

    .form-panel.active {
      display: block;
    }

    .input-group {
      margin-bottom: 20px;
      position: relative;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }

    .input-wrapper {
      position: relative;
    }

    .input-wrapper i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    .form-input {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .form-input:focus {
      outline: none;
      border-color: #1e3a8a;
      box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }

    .form-input.error {
      border-color: #ef4444;
    }

    .error-message {
      color: #ef4444;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 25px;
    }

    .checkbox-group input[type="checkbox"] {
      margin-right: 10px;
      margin-top: 2px;
    }

    .checkbox-group label {
      font-size: 14px;
      color: #4b5563;
      line-height: 1.4;
    }

    .checkbox-group a {
      color: #1e3a8a;
      text-decoration: none;
    }

    .checkbox-group a:hover {
      text-decoration: underline;
    }

    .submit-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(30, 58, 138, 0.3);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .submit-btn .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .forgot-password {
      text-align: center;
      margin-top: 20px;
    }

    .forgot-password a {
      color: #1e3a8a;
      text-decoration: none;
      font-size: 14px;
    }

    .forgot-password a:hover {
      text-decoration: underline;
    }

    .back-to-login {
      text-align: center;
      margin-top: 20px;
    }

    .back-to-login a {
      color: #1e3a8a;
      text-decoration: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .back-to-login a:hover {
      text-decoration: underline;
    }

    .success-message {
      text-align: center;
      padding: 40px;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .success-icon {
      font-size: 64px;
      color: #10b981;
      margin-bottom: 20px;
    }

    .success-title {
      font-size: 24px;
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 10px;
    }

    .success-text {
      color: #6b7280;
      font-size: 16px;
      margin-bottom: 30px;
    }

    .continue-btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .continue-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(30, 58, 138, 0.3);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      max-width: 350px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .notification.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .notification.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .info-box {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      color: #0369a1;
      font-size: 14px;
      line-height: 1.5;
    }

    .info-box i {
      margin-right: 8px;
      color: #0284c7;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .auth-container {
        flex-direction: column;
        max-width: 400px;
        margin: 20px;
      }

      .welcome-section {
        order: -1;
        padding: 40px 30px;
        min-height: auto;
      }

      .auth-section {
        padding: 40px 30px;
        min-height: auto;
      }

      .welcome-title {
        font-size: 24px;
      }

      .welcome-subtitle {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
<div class="auth-container" id="authContainer">
  <!-- Welcome Section -->
  <div class="welcome-section">
    <div class="welcome-content">
      <div class="logo">
        <i class="fas fa-tasks"></i>
      </div>
      <h1 class="welcome-title">Task Manager Pro</h1>
      <p class="welcome-subtitle">
        The complete productivity solution with EmailJS-powered password reset.
      </p>

      <div class="features-list">
        <div class="feature-item">
          <i class="fas fa-envelope"></i>
          <span>Real email notifications</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-shield-alt"></i>
          <span>Secure password reset</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-clock"></i>
          <span>1-hour token expiry</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-user-shield"></i>
          <span>User data isolation</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-sync"></i>
          <span>Cross-device sync</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-mobile-alt"></i>
          <span>Mobile responsive</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Section -->
  <div class="auth-section">
    <div class="auth-form">
      <div class="form-header">
        <h2 id="formTitle">Welcome Back</h2>
        <p id="formSubtitle">Sign in to continue your productivity journey</p>
      </div>

      <div class="form-tabs" id="formTabs">
        <button class="tab-btn active" id="loginTab">Sign In</button>
        <button class="tab-btn" id="signupTab">Sign Up</button>
      </div>

      <div class="form-content">
        <!-- Login Form -->
        <div class="form-panel active" id="loginPanel">
          <form id="loginForm">
            <div class="input-group">
              <label for="loginEmail">Email Address</label>
              <div class="input-wrapper">
                <i class="fas fa-envelope"></i>
                <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
              </div>
              <div class="error-message" id="loginEmailError"></div>
            </div>

            <div class="input-group">
              <label for="loginPassword">Password</label>
              <div class="input-wrapper">
                <i class="fas fa-lock"></i>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
              </div>
              <div class="error-message" id="loginPasswordError"></div>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="rememberMe">
              <label for="rememberMe">Keep me signed in</label>
            </div>

            <button type="submit" class="submit-btn" id="loginBtn">
              <span class="btn-text">Sign In</span>
              <div class="spinner"></div>
            </button>
          </form>

          <div class="forgot-password">
            <a href="#" id="forgotPasswordLink">Forgot your password?</a>
          </div>
        </div>

        <!-- Signup Form -->
        <div class="form-panel" id="signupPanel">
          <form id="signupForm">
            <div class="input-group">
              <label for="signupName">Full Name</label>
              <div class="input-wrapper">
                <i class="fas fa-user"></i>
                <input type="text" id="signupName" class="form-input" placeholder="Enter your full name" required>
              </div>
              <div class="error-message" id="signupNameError"></div>
            </div>

            <div class="input-group">
              <label for="signupEmail">Email Address</label>
              <div class="input-wrapper">
                <i class="fas fa-envelope"></i>
                <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email" required>
              </div>
              <div class="error-message" id="signupEmailError"></div>
            </div>

            <div class="input-group">
              <label for="signupPassword">Password</label>
              <div class="input-wrapper">
                <i class="fas fa-lock"></i>
                <input type="password" id="signupPassword" class="form-input" placeholder="Create a password" required>
              </div>
              <div class="error-message" id="signupPasswordError"></div>
            </div>

            <div class="input-group">
              <label for="confirmPassword">Confirm Password</label>
              <div class="input-wrapper">
                <i class="fas fa-lock"></i>
                <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm your password" required>
              </div>
              <div class="error-message" id="confirmPasswordError"></div>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="agreeTerms" required>
              <label for="agreeTerms">
                I agree to the <a href="#" id="termsLink">Terms of Service</a> and
                <a href="#" id="privacyLink">Privacy Policy</a>
              </label>
            </div>

            <button type="submit" class="submit-btn" id="signupBtn">
              <span class="btn-text">Create Account</span>
              <div class="spinner"></div>
            </button>
          </form>
        </div>

        <!-- Forgot Password Form -->
        <div class="form-panel" id="forgotPasswordPanel">
          <div class="info-box">
            <i class="fas fa-info-circle"></i>
            Enter your email and we'll send you a secure reset link using EmailJS.
          </div>

          <form id="forgotPasswordForm">
            <div class="input-group">
              <label for="forgotEmail">Email Address</label>
              <div class="input-wrapper">
                <i class="fas fa-envelope"></i>
                <input type="email" id="forgotEmail" class="form-input" placeholder="Enter your email" required>
              </div>
              <div class="error-message" id="forgotEmailError"></div>
            </div>

            <button type="submit" class="submit-btn" id="forgotBtn">
              <span class="btn-text">Send Reset Link</span>
              <div class="spinner"></div>
            </button>
          </form>

          <div class="back-to-login">
            <a href="#" id="backToLoginLink">
              <i class="fas fa-arrow-left"></i>
              Back to Sign In
            </a>
          </div>
        </div>

        <!-- Reset Password Form -->
        <div class="form-panel" id="resetPasswordPanel">
          <div class="info-box">
            <i class="fas fa-shield-alt"></i>
            Create a new password for your account. Make sure it's strong and secure.
          </div>

          <form id="resetPasswordForm">
            <div class="input-group">
              <label for="newPassword">New Password</label>
              <div class="input-wrapper">
                <i class="fas fa-lock"></i>
                <input type="password" id="newPassword" class="form-input" placeholder="Create a new password" required>
              </div>
              <div class="error-message" id="newPasswordError"></div>
            </div>

            <div class="input-group">
              <label for="confirmNewPassword">Confirm New Password</label>
              <div class="input-wrapper">
                <i class="fas fa-lock"></i>
                <input type="password" id="confirmNewPassword" class="form-input" placeholder="Confirm your new password" required>
              </div>
              <div class="error-message" id="confirmNewPasswordError"></div>
            </div>

            <button type="submit" class="submit-btn" id="resetBtn">
              <span class="btn-text">Reset Password</span>
              <div class="spinner"></div>
            </button>
          </form>

          <div class="back-to-login">
            <a href="#" id="backToLoginFromResetLink">
              <i class="fas fa-arrow-left"></i>
              Back to Sign In
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3 class="success-title">Welcome to Task Manager Pro!</h3>
      <p class="success-text">Your account has been created successfully. Let's get you started on your productivity journey.</p>
      <button class="continue-btn" id="continueBtn">Continue to Dashboard</button>
    </div>

    <!-- Password Reset Success Message -->
    <div class="success-message" id="resetSuccessMessage">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3 class="success-title">Password Reset Successful!</h3>
      <p class="success-text">Your password has been updated successfully. You can now sign in with your new password.</p>
      <button class="continue-btn" id="continueToLoginBtn">Continue to Sign In</button>
    </div>
  </div>
</div>

<!-- Load EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
  // STEP 1: EmailJS Configuration - YOUR ACTUAL CREDENTIALS
  const EMAILJS_CONFIG = {
    publicKey: 'uMixcUe9ZP9K1YB6l',      // Your EmailJS Public Key
    serviceId: 'service_tkzvmsl',        // Your EmailJS Service ID (UPDATED)
    templateId: 'template_7tvfwdy'       // Your EmailJS Template ID (UPDATED)
  };

  // STEP 2: EmailJS Service Class
  class EmailJSPasswordReset {
    constructor() {
      this.resetTokens = JSON.parse(localStorage.getItem('resetTokens') || '{}');
      this.init();
    }

    async init() {
      try {
        // Initialize EmailJS
        emailjs.init(EMAILJS_CONFIG.publicKey);
        console.log('📧 EmailJS initialized successfully');
      } catch (error) {
        console.error('❌ EmailJS initialization failed:', error);
      }

      this.cleanupExpiredTokens();
    }

    // Generate secure token
    generateResetToken() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let token = '';
      for (let i = 0; i < 32; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return token;
    }

    // Create reset token for user
    createResetToken(email) {
      const token = this.generateResetToken();
      const expiry = new Date();
      expiry.setHours(expiry.getHours() + 1); // Token expires in 1 hour

      this.resetTokens[token] = {
        email: email,
        expiry: expiry.toISOString(),
        used: false,
        createdAt: new Date().toISOString()
      };

      localStorage.setItem('resetTokens', JSON.stringify(this.resetTokens));
      return token;
    }

    // STEP 3: Send password reset email using EmailJS
    async sendPasswordResetEmail(email, token) {
      try {
        console.log(`📧 Sending password reset email to: ${email}`);

        // Get user name
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const user = users.find(u => u.email === email);
        const userName = user ? user.name : email.split('@')[0];

        // Create reset URL
        const resetUrl = `${window.location.origin}${window.location.pathname}?reset=${token}`;

        // Template parameters that match your EmailJS template
        const templateParams = {
          to_email: email,
          to_name: userName,
          reset_url: resetUrl,
          expiry_time: '1 hour',
          app_name: 'Task Manager Pro',
          support_email: 'support@taskmanagerpro.com'
        };

        console.log('📨 Sending email with parameters:', templateParams);

        // Send email using EmailJS
        const result = await emailjs.send(
                EMAILJS_CONFIG.serviceId,
                EMAILJS_CONFIG.templateId,
                templateParams,
                { publicKey: EMAILJS_CONFIG.publicKey }
        );

        console.log('✅ Email sent successfully:', result);

        return {
          success: true,
          message: 'Password reset email sent successfully',
          messageId: result.text
        };

      } catch (error) {
        console.error('❌ EmailJS send failed:', error);

        // Handle specific EmailJS errors
        let errorMessage = 'Failed to send reset email';

        if (error.status === 412) {
          errorMessage = 'Email service needs reconnection. Please try again later.';
        } else if (error.status === 403) {
          errorMessage = 'Email service temporarily unavailable. Please try again.';
        } else if (error.status === 429) {
          errorMessage = 'Too many requests. Please wait before trying again.';
        }

        return {
          success: false,
          error: error.text || error.message,
          message: errorMessage
        };
      }
    }

    // Validate reset token
    validateResetToken(token) {
      const tokenData = this.resetTokens[token];

      if (!tokenData) {
        return { valid: false, error: 'Invalid reset token' };
      }

      if (tokenData.used) {
        return { valid: false, error: 'Reset token has already been used' };
      }

      if (new Date() > new Date(tokenData.expiry)) {
        return { valid: false, error: 'Reset token has expired' };
      }

      return { valid: true, email: tokenData.email };
    }

    // Mark token as used
    markTokenAsUsed(token) {
      if (this.resetTokens[token]) {
        this.resetTokens[token].used = true;
        this.resetTokens[token].usedAt = new Date().toISOString();
        localStorage.setItem('resetTokens', JSON.stringify(this.resetTokens));
      }
    }

    // Clean up expired tokens
    cleanupExpiredTokens() {
      const now = new Date();
      let cleaned = false;

      for (const token in this.resetTokens) {
        if (new Date(this.resetTokens[token].expiry) < now) {
          delete this.resetTokens[token];
          cleaned = true;
        }
      }

      if (cleaned) {
        localStorage.setItem('resetTokens', JSON.stringify(this.resetTokens));
      }
    }

    delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  }

  // STEP 4: Enhanced Authentication System with EmailJS
  class AuthSystemWithEmailJS {
    constructor() {
      this.users = JSON.parse(localStorage.getItem('users') || '[]');
      this.currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      this.passwordReset = new EmailJSPasswordReset();
      this.init();
    }

    init() {
      this.setupEventListeners();
      this.checkAuthState();
      this.checkResetToken();
    }

    setupEventListeners() {
      // Tab switching
      document.getElementById('loginTab').addEventListener('click', () => this.switchTab('login'));
      document.getElementById('signupTab').addEventListener('click', () => this.switchTab('signup'));

      // Form submissions
      document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
      document.getElementById('signupForm').addEventListener('submit', (e) => this.handleSignup(e));
      document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => this.handleForgotPassword(e));
      document.getElementById('resetPasswordForm').addEventListener('submit', (e) => this.handlePasswordReset(e));

      // Continue buttons
      document.getElementById('continueBtn').addEventListener('click', () => this.redirectToDashboard());
      document.getElementById('continueToLoginBtn').addEventListener('click', () => this.showLoginForm());

      // Navigation links
      document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
        e.preventDefault();
        this.showForgotPasswordForm();
      });

      document.getElementById('backToLoginLink').addEventListener('click', (e) => {
        e.preventDefault();
        this.showLoginForm();
      });

      document.getElementById('backToLoginFromResetLink').addEventListener('click', (e) => {
        e.preventDefault();
        this.showLoginForm();
      });
    }

    // Check for reset token in URL
    checkResetToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const resetToken = urlParams.get('reset');

      if (resetToken) {
        this.handleResetTokenFromURL(resetToken);
      }
    }

    // Handle reset token from URL
    handleResetTokenFromURL(token) {
      const validation = this.passwordReset.validateResetToken(token);

      if (validation.valid) {
        this.showResetPasswordForm(token, validation.email);
        this.showNotification('Please enter your new password', 'success');
      } else {
        this.showNotification(validation.error, 'error');
        this.showLoginForm();
      }

      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // STEP 5: Handle forgot password with EmailJS
    async handleForgotPassword(e) {
      e.preventDefault();
      this.clearErrors();

      const email = document.getElementById('forgotEmail').value.trim();

      if (!this.validateEmail('forgot')) {
        return;
      }

      // Check if user exists
      const user = this.users.find(u => u.email === email);
      if (!user) {
        this.showError('forgotEmailError', 'No account found with this email address');
        return;
      }

      this.setLoading('forgotBtn', true);

      try {
        // Generate reset token
        const resetToken = this.passwordReset.createResetToken(email);

        // Send reset email using EmailJS
        const result = await this.passwordReset.sendPasswordResetEmail(email, resetToken);

        if (result.success) {
          this.setLoading('forgotBtn', false);
          this.showNotification('Password reset email sent! Check your inbox.', 'success');

          // For demo/testing: show reset link in console
          const resetUrl = `${window.location.origin}${window.location.pathname}?reset=${resetToken}`;
          console.log(`🔗 Reset link for testing: ${resetUrl}`);

          // Go back to login form after delay
          setTimeout(() => {
            this.showLoginForm();
          }, 3000);
        } else {
          this.setLoading('forgotBtn', false);
          this.showNotification(result.message, 'error');
        }
      } catch (error) {
        this.setLoading('forgotBtn', false);
        this.showNotification('Failed to send reset email. Please try again.', 'error');
        console.error('Password reset error:', error);
      }
    }

    // Handle password reset form submission
    async handlePasswordReset(e) {
      e.preventDefault();
      this.clearErrors();

      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;
      const resetToken = document.getElementById('resetPasswordForm').dataset.token;
      const userEmail = document.getElementById('resetPasswordForm').dataset.email;

      // Validation
      let hasErrors = false;

      if (!this.isPasswordStrong(newPassword)) {
        this.showError('newPasswordError', 'Password must be at least 8 characters with uppercase, lowercase, number and special character');
        hasErrors = true;
      }

      if (newPassword !== confirmNewPassword) {
        this.showError('confirmNewPasswordError', 'Passwords do not match');
        hasErrors = true;
      }

      if (hasErrors) return;

      this.setLoading('resetBtn', true);

      // Simulate API call
      await this.delay(1500);

      // Validate token again
      const validation = this.passwordReset.validateResetToken(resetToken);
      if (!validation.valid) {
        this.setLoading('resetBtn', false);
        this.showNotification(validation.error, 'error');
        this.showLoginForm();
        return;
      }

      // Update user password
      const userIndex = this.users.findIndex(u => u.email === userEmail);
      if (userIndex !== -1) {
        this.users[userIndex].password = newPassword;
        localStorage.setItem('users', JSON.stringify(this.users));

        // Mark token as used
        this.passwordReset.markTokenAsUsed(resetToken);

        this.setLoading('resetBtn', false);

        // Show success message
        this.showResetSuccessMessage();
      } else {
        this.setLoading('resetBtn', false);
        this.showNotification('User not found. Please try again.', 'error');
      }
    }

    // Show different form panels
    showLoginForm() {
      this.hideAllPanels();
      document.getElementById('loginPanel').classList.add('active');
      document.getElementById('formTabs').style.display = 'flex';
      document.getElementById('loginTab').classList.add('active');
      document.getElementById('signupTab').classList.remove('active');
      document.getElementById('formTitle').textContent = 'Welcome Back';
      document.getElementById('formSubtitle').textContent = 'Sign in to continue your productivity journey';
      this.clearErrors();
    }

    showForgotPasswordForm() {
      this.hideAllPanels();
      document.getElementById('forgotPasswordPanel').classList.add('active');
      document.getElementById('formTabs').style.display = 'none';
      document.getElementById('formTitle').textContent = 'Reset Password';
      document.getElementById('formSubtitle').textContent = 'Enter your email to receive a reset link';
      this.clearErrors();
    }

    showResetPasswordForm(token, email) {
      this.hideAllPanels();
      document.getElementById('resetPasswordPanel').classList.add('active');
      document.getElementById('formTabs').style.display = 'none';
      document.getElementById('formTitle').textContent = 'Create New Password';
      document.getElementById('formSubtitle').textContent = 'Enter your new password below';

      // Store token and email for form submission
      const form = document.getElementById('resetPasswordForm');
      form.dataset.token = token;
      form.dataset.email = email;

      this.clearErrors();
    }

    showResetSuccessMessage() {
      const authForm = document.querySelector('.auth-form');
      const resetSuccessMessage = document.getElementById('resetSuccessMessage');

      authForm.style.display = 'none';
      resetSuccessMessage.classList.add('show');
    }

    hideAllPanels() {
      const panels = document.querySelectorAll('.form-panel');
      panels.forEach(panel => panel.classList.remove('active'));

      const successMessages = document.querySelectorAll('.success-message');
      successMessages.forEach(msg => {
        msg.classList.remove('show');
        msg.style.display = 'none';
      });

      document.querySelector('.auth-form').style.display = 'block';
    }

    // Keep all your existing authentication methods
    async handleLogin(e) {
      e.preventDefault();
      this.clearErrors();

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      if (!this.validateEmail('login') || !password) {
        this.showError('loginPasswordError', 'Please enter your password');
        return;
      }

      this.setLoading('loginBtn', true);
      await this.delay(1500);

      const user = this.users.find(u => u.email === email && u.password === password);

      if (!user) {
        this.setLoading('loginBtn', false);
        this.showError('loginEmailError', 'Invalid email or password');
        this.showNotification('Invalid credentials. Please try again.', 'error');
        return;
      }

      this.currentUser = { ...user };
      delete this.currentUser.password;

      sessionStorage.setItem('currentUser', JSON.stringify(this.currentUser));
      sessionStorage.setItem('isAuthenticated', 'true');
      sessionStorage.setItem('loginTime', new Date().toISOString());

      if (rememberMe) {
        localStorage.setItem('rememberedUser', email);
      } else {
        localStorage.removeItem('rememberedUser');
      }

      this.setLoading('loginBtn', false);
      this.showNotification(`Welcome back, ${user.name}!`, 'success');

      await this.delay(1000);
      this.redirectToDashboard();
    }

    async handleSignup(e) {
      e.preventDefault();
      this.clearErrors();

      const name = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const agreeTerms = document.getElementById('agreeTerms').checked;

      let hasErrors = false;

      if (!name || name.length < 2) {
        this.showError('signupNameError', 'Name must be at least 2 characters');
        hasErrors = true;
      }

      if (!this.validateEmail('signup')) {
        hasErrors = true;
      }

      if (!this.isPasswordStrong(password)) {
        this.showError('signupPasswordError', 'Password must be at least 8 characters with uppercase, lowercase, number and special character');
        hasErrors = true;
      }

      if (password !== confirmPassword) {
        this.showError('confirmPasswordError', 'Passwords do not match');
        hasErrors = true;
      }

      if (!agreeTerms) {
        this.showNotification('Please agree to the Terms of Service and Privacy Policy', 'error');
        hasErrors = true;
      }

      if (hasErrors) return;

      if (this.users.find(u => u.email === email)) {
        this.showError('signupEmailError', 'An account with this email already exists');
        this.showNotification('Email already registered. Try signing in instead.', 'error');
        return;
      }

      this.setLoading('signupBtn', true);
      await this.delay(2000);

      const newUser = {
        id: Date.now(),
        name,
        email,
        password,
        createdAt: new Date().toISOString(),
        preferences: {
          theme: 'light',
          notifications: true,
          language: 'en'
        }
      };

      this.users.push(newUser);
      localStorage.setItem('users', JSON.stringify(this.users));

      this.currentUser = { ...newUser };
      delete this.currentUser.password;

      sessionStorage.setItem('currentUser', JSON.stringify(this.currentUser));
      sessionStorage.setItem('isAuthenticated', 'true');
      sessionStorage.setItem('loginTime', new Date().toISOString());

      this.setLoading('signupBtn', false);
      this.showSuccess();
    }

    validateEmail(type) {
      const emailInput = document.getElementById(`${type}Email`);
      const email = emailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!email) {
        this.showError(`${type}EmailError`, 'Email is required');
        return false;
      }

      if (!emailRegex.test(email)) {
        this.showError(`${type}EmailError`, 'Please enter a valid email address');
        return false;
      }

      this.clearError(`${type}EmailError`);
      return true;
    }

    isPasswordStrong(password) {
      return password.length >= 8 &&
              /[A-Z]/.test(password) &&
              /[a-z]/.test(password) &&
              /\d/.test(password) &&
              /[!@#$%^&*(),.?":{}|<>]/.test(password);
    }

    showSuccess() {
      const authForm = document.querySelector('.auth-form');
      const successMessage = document.getElementById('successMessage');

      authForm.style.display = 'none';
      successMessage.classList.add('show');
    }

    showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      const inputElement = errorElement.previousElementSibling.querySelector('input');

      errorElement.textContent = message;
      errorElement.style.display = 'block';
      inputElement.classList.add('error');
    }

    clearError(elementId) {
      const errorElement = document.getElementById(elementId);
      const inputElement = errorElement.previousElementSibling.querySelector('input');

      errorElement.style.display = 'none';
      inputElement.classList.remove('error');
    }

    clearErrors() {
      const errorElements = document.querySelectorAll('.error-message');
      const inputElements = document.querySelectorAll('.form-input');

      errorElements.forEach(el => el.style.display = 'none');
      inputElements.forEach(el => el.classList.remove('error'));
    }

    setLoading(buttonId, loading) {
      const button = document.getElementById(buttonId);
      const spinner = button.querySelector('.spinner');
      const text = button.querySelector('.btn-text');

      if (loading) {
        button.disabled = true;
        spinner.style.display = 'block';
        text.style.display = 'none';
      } else {
        button.disabled = false;
        spinner.style.display = 'none';
        text.style.display = 'block';
      }
    }

    showNotification(message, type = 'success') {
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(n => n.remove());

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
            <span>${message}</span>
        `;

      document.body.appendChild(notification);

      setTimeout(() => notification.classList.add('show'), 100);

      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    switchTab(tab) {
      const loginTab = document.getElementById('loginTab');
      const signupTab = document.getElementById('signupTab');
      const loginPanel = document.getElementById('loginPanel');
      const signupPanel = document.getElementById('signupPanel');
      const formTitle = document.getElementById('formTitle');
      const formSubtitle = document.getElementById('formSubtitle');

      document.getElementById('formTabs').style.display = 'flex';

      if (tab === 'login') {
        loginTab.classList.add('active');
        signupTab.classList.remove('active');
        loginPanel.classList.add('active');
        signupPanel.classList.remove('active');
        formTitle.textContent = 'Welcome Back';
        formSubtitle.textContent = 'Sign in to continue your productivity journey';
      } else {
        signupTab.classList.add('active');
        loginTab.classList.remove('active');
        signupPanel.classList.add('active');
        loginPanel.classList.remove('active');
        formTitle.textContent = 'Create Account';
        formSubtitle.textContent = 'Join thousands of productive users';
      }

      this.clearErrors();
    }

    checkAuthState() {
      const rememberedUser = localStorage.getItem('rememberedUser');
      if (rememberedUser) {
        document.getElementById('loginEmail').value = rememberedUser;
      }

      if (this.currentUser) {
        this.showNotification(`Welcome back, ${this.currentUser.name}!`, 'success');
        setTimeout(() => this.redirectToDashboard(), 2000);
      }
    }

    redirectToDashboard() {
      sessionStorage.setItem('isAuthenticated', 'true');
      sessionStorage.setItem('loginTime', new Date().toISOString());
      window.location.href = 'todo.html';
    }

    delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    getCurrentUser() {
      return this.currentUser;
    }
  }

  // STEP 6: Initialize the system
  const auth = new AuthSystemWithEmailJS();
  window.authSystem = auth;

  // Create demo users if none exist
  if (!localStorage.getItem('users')) {
    const demoUsers = [
      {
        id: 1,
        name: 'John Demo',
        email: 'demo@example.com',
        password: 'Demo123!',
        createdAt: new Date().toISOString(),
        preferences: {
          theme: 'light',
          notifications: true,
          language: 'en'
        }
      },
      {
        id: 2,
        name: 'Jane Smith',
        email: 'jane@example.com',
        password: 'Jane123!',
        createdAt: new Date().toISOString(),
        preferences: {
          theme: 'light',
          notifications: true,
          language: 'en'
        }
      }
    ];
    localStorage.setItem('users', JSON.stringify(demoUsers));
  }

  // STEP 7: Testing functions
  window.testEmailJS = async function(testEmail) {
    console.log('🧪 Testing EmailJS integration...');

    // Use provided email or prompt for one
    const email = testEmail || prompt('Enter your email address for testing:');

    if (!email) {
      console.error('❌ No email provided');
      return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      console.error('❌ Invalid email format');
      alert('Please enter a valid email address');
      return;
    }

    try {
      const testParams = {
        to_email: email,
        to_name: email.split('@')[0], // Use part before @ as name
        reset_url: `${window.location.origin}${window.location.pathname}?reset=test123456789`,
        expiry_time: '1 hour',
        app_name: 'Task Manager Pro',
        support_email: 'support@taskmanagerpro.com'
      };

      console.log('📨 Sending test email to:', email);
      console.log('📋 Template parameters:', testParams);

      const result = await emailjs.send(
              EMAILJS_CONFIG.serviceId,
              EMAILJS_CONFIG.templateId,
              testParams,
              { publicKey: EMAILJS_CONFIG.publicKey }
      );

      console.log('✅ Test email sent successfully:', result);
      alert(`✅ Test email sent to ${email}! Check your inbox (and spam folder).`);

      return result;
    } catch (error) {
      console.error('❌ Test failed:', error);

      // Provide specific error messages
      let errorMessage = 'Unknown error occurred';

      if (error.status === 412) {
        errorMessage = 'EmailJS service needs reconnection. Please reconnect your email service in the EmailJS dashboard.';
      } else if (error.status === 403) {
        errorMessage = 'Access denied. Check your EmailJS credentials and service configuration.';
      } else if (error.status === 400) {
        errorMessage = 'Bad request. Check your template variables and email address format.';
      } else if (error.text) {
        errorMessage = error.text;
      }

      alert(`❌ Test failed: ${errorMessage}`);

      // Show debugging info
      console.log('🔍 Debug info:');
      console.log('Public Key:', EMAILJS_CONFIG.publicKey);
      console.log('Service ID:', EMAILJS_CONFIG.serviceId);
      console.log('Template ID:', EMAILJS_CONFIG.templateId);
      console.log('Error details:', error);

      return false;
    }
  };

  window.createTestResetLink = function(email = 'demo@example.com') {
    if (auth.passwordReset) {
      const token = auth.passwordReset.createResetToken(email);
      const resetUrl = `${window.location.origin}${window.location.pathname}?reset=${token}`;
      console.log(`🔗 Test reset URL: ${resetUrl}`);
      alert(`Test reset link created! Check console for URL.`);
      return resetUrl;
    }
  };

  // NEW: Simple test with your actual email
  window.testWithYourEmail = async function() {
    const email = prompt('Enter YOUR email address to test:');
    if (email) {
      return await window.testEmailJS(email);
    }
  };

  // NEW: Debug EmailJS configuration
  window.debugEmailJS = function() {
    console.log('🔍 EmailJS Configuration Debug:');
    console.log('Public Key:', EMAILJS_CONFIG.publicKey);
    console.log('Service ID:', EMAILJS_CONFIG.serviceId);
    console.log('Template ID:', EMAILJS_CONFIG.templateId);
    console.log('EmailJS loaded:', typeof emailjs !== 'undefined');
    console.log('EmailJS version:', emailjs?.version || 'Unknown');

    // Test basic EmailJS initialization
    try {
      emailjs.init(EMAILJS_CONFIG.publicKey);
      console.log('✅ EmailJS initialization successful');
    } catch (error) {
      console.error('❌ EmailJS initialization failed:', error);
    }
  };

  console.log('🔐 EmailJS Password Reset System loaded');
  console.log('📧 Demo Accounts Available:');
  console.log('  - demo@example.com / Demo123!');
  console.log('  - jane@example.com / Jane123!');
  console.log('');
  console.log('🛠️ Setup Instructions:');
  console.log('1. Go to https://www.emailjs.com/ and create account');
  console.log('2. Add email service (Gmail, Outlook, etc.)');
  console.log('3. Create email template');
  console.log('4. Update EMAILJS_CONFIG object above with your credentials');
  console.log('5. Test with: window.testEmailJS()');
  console.log('');
  console.log('🔗 Create test reset link: window.createTestResetLink("your-email@example.com")');
</script>
</body>
</html>